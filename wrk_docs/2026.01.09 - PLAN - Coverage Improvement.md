# Coverage Improvement Plan
**Date:** 2026-01-09
**Goal:** Increase code coverage to >98%.

## Strategy
The primary blocker is that integration tests use subprocesses (`std::process::Command`), hiding coverage from `cargo-llvm-cov`. We will refactor the core logic to be "IO-injectable," allowing tests to run in-process and capture output. We will also refactor the self-update logic to be testable.

## Stages

### Stage 1: IO Refactoring for Testability
**Objective:** Enable capturing `stdout` and `stderr` from library functions.
**Tasks:**
1.  Define a `nice_print` helper or passing `&mut impl Write` to `run_with_options` is too intrusive for the whole call stack.
2.  *Better Approach:* Create a `Context` or `Runtime` struct that holds the writers and environment abstractions.
3.  Refactor `run_with_options` to accept this `Runtime` (or just `stdout/stderr` writers for now to keep it simple).
4.  Replace all `println!` and `eprintln!` in `src/lib.rs` with `writeln!(out, ...)` and `writeln!(err, ...)`.
5.  Update `src/main.rs` to pass `std::io::stdout()` and `std::io::stderr()`.

### Stage 2: Integration Test Conversion
**Objective:** Restore missing coverage by running tests in-process.
**Tasks:**
1.  Modify `tests/integration.rs`.
2.  Replace `std::process::Command` calls with direct calls to `mdrcp::run_with_options`, passing `Vec<u8>` buffers to capture output.
3.  Verify tests still pass and assertions on output (JSON/Text) work.

### Stage 3: Self-Update Coverage
**Objective:** Test the self-update mechanism.
**Tasks:**
1.  Refactor `try_self_update` and `is_self_update_target`.
2.  Abstract `std::env::current_exe()` behind a trait or functional interface.
3.  Write a test that mimics "current exe" matches "target" to trigger the logic, verifying the `spawn` or `copy` attempt without actually destroying the test runner.

### Stage 4: Edge Case Cleanup
**Objective:** Reach 98% coverage.
**Tasks:**
1.  Add unit tests for `manifest_bin_names` fallback logic.
2.  Add tests for `fs::create_dir_all` failures (using a read-only path or mock).
3.  Add tests for invalid `project_type` detection edge cases.

## Execution Order
1.  **Stage 1** (Refactor IO)
2.  **Stage 2** (Fix Tests)
3.  **Check Coverage** (Should jump to ~80%+)
4.  **Stage 3** (Self-Update)
5.  **Stage 4** (Edge Cases)
