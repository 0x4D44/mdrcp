# Coverage Improvement Plan (to ≥98%)

Goals
- Raise line coverage from 85.44% to ≥98%.
- Improve function coverage by testing error paths and entry behavior.
- Avoid Linux runs counting Windows-only code.

Steps
1) Compile-time OS branches
   - Replace runtime `cfg!(windows)` branches with `#[cfg(windows)]`/`#[cfg(not(windows))]` helpers (`exe_filename`, `default_target_dir`).
   - Rationale: exclude Windows-only lines from Linux builds, removing unreachable code from coverage accounting.

2) Testable entry point
   - Extract `do_main(cwd: &Path) -> i32` containing current `main` logic; keep `main` as thin wrapper calling `process::exit(do_main(Path::new(".")))`.
   - Rationale: unit-test the error/usage printing path without exiting the process.

3) Add focused unit tests
   - `test_manifest_bin_names_path_only`: cover path-stem fallback when `[[bin]]` has only `path`.
   - `test_no_packages_or_bins`: empty manifest yields `No packages or bins found` error.
   - `test_default_target_dir_home_missing` (non-Windows): unset `HOME` to exercise error branch.
   - `test_copy_failure_existing_dir` (non-Windows): precreate `~/.local/bin/<exe>` as directory to force `fs::copy` failure and hit context closure.
   - `test_do_main_error_exit_code`: run `do_main` in dir without `Cargo.toml` and assert exit code `1`.

4) Re-run coverage, iterate if needed
   - If <98%, add one more negative-path test: failed member read or malformed member manifest to cover workspace reading fallbacks.

Success Criteria
- `cargo llvm-cov --summary-only` shows ≥98% lines for `src/main.rs`.
