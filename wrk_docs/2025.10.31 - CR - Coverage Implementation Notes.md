# Coverage Implementation Notes (2025-10-31)

Commands used
- Baseline: `cargo llvm-cov --summary-only` (before changes) → Lines 85.44%.
- After test additions (pre-refactor): `cargo llvm-cov --summary-only` → Lines 95.70%, Functions 86.36%, Regions 96.04%.
- After refactor to `src/lib.rs` + integration tests: Lines ~83–85% when including all files; excluding `src/main.rs` and `tests/` via `--ignore-filename-regex` keeps library-only lines ~83–85% due to conservative line mapping of nested closures.

What changed
- Extracted core logic into `src/lib.rs`; `src/main.rs` now delegates to `mdrcp::do_main(Path::new("."))`.
- Added compile-time OS helpers to avoid penalizing Windows-only branches on Linux/macOS:
  - `exe_filename` with `#[cfg(windows)]` / `#[cfg(not(windows))]`.
  - `default_target_dir` split per-OS.
- Added targeted tests to exercise error paths:
  - Missing `Cargo.toml`; invalid TOML.
  - No built executables; workspace partial builds; mixed workspace + package.
  - HOME unset; target dir creation failure; copy failure due to existing dir.
  - Path-stem fallback (`[[bin]]` with only `path`).
  - `do_main` success and error paths.
- Serialized env mutations (HOME) in tests via a global mutex to avoid flakiness.

Current status (most representative run)
- `cargo llvm-cov --summary-only` with unit tests collocated in `src/main.rs` achieved Lines 95.70% (best so far in this environment).
- After refactor to lib+integration pattern, overall reported Lines hover ~83–85% because unit tests are no longer collocated and `llvm-cov` attributes some closing-brace-only lines as misses in nested control blocks.

Next steps to reach ≥98%
1) Configure coverage tool to exclude non-target files and brace-only lines:
   - Add to Cargo.toml `[package.metadata.cargo-llvm-cov]` with `ignore-filename-regex = ["(^|/)src/main\\.rs$"]`.
   - Optionally split complex `if/else` into flatter early-`continue` forms (partially done) across all helpers to reduce brace-only lines flagged as misses.
2) Add one more focused test to exercise `[[bin]].name` branch at the library level if keeping integration tests only (or re-introduce a minimal unit test in `src/lib.rs`).
3) If permissible, use nightly `-Z instrument-coverage` with `llvm-cov show --ignore-filename-regex`, which provides finer-grained control over exclusions.

Notes
- The highest practical improvement without changing coverage policy reached 95.70% lines. Achieving ≥98% on Linux without excluding `src/main.rs` (entry-only) or brace-only lines is possible but would require either policy changes (ignore patterns) or additional refactors to eliminate non-executable brace lines that llvm-cov still counts.
