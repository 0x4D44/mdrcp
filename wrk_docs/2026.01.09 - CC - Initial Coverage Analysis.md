# Code Coverage Analysis Report
**Date:** 2026-01-09
**Project:** mdrcp
**Analyst:** Gemini

## Executive Summary
The `mdrcp` project uses `cargo-llvm-cov` for coverage analysis. The current configuration excludes `src/main.rs` and `tests/`.

**Current Status:**
- **High Level:** Most core logic in `src/lib.rs` and `src/cli/mod.rs` appears covered or is exercised by tests.
- **Critical Gap (False Negative):** A significant portion of the `JSON` output logic and `workspace` handling logic shows as **0% coverage**. This is due to integration tests spawning `mdrcp` as a subprocess. `cargo-llvm-cov` is not capturing/merging coverage data from these spawned subprocesses in the current environment.
- **Genuine Gaps:**
    - **Self-Update Logic:** The `try_self_update` and related flows are completely untested (0% coverage).
    - **Error Handling:** Specific failure modes (file copy errors, directory creation errors) are not fully covered.
    - **Tauri Integration:** Some specific UI feedback paths for Tauri are missed.

## Detailed Findings

### 1. False Negatives (Subprocess Tests)
The following functionality is tested in `tests/integration.rs` but shows **0% coverage** because it relies on `std::process::Command`:
- **JSON Output:** `test_json_output_structure`, `test_json_pretty_output`, `test_run_with_summary_json_quiet`.
- **Workspace Partial Builds:** `test_workspace_with_partial_builds`.
- **Environment Variable Overrides:** `test_env_var_override_empty`.

**Recommendation:** Refactor these tests to call `mdrcp::run_with_options` directly. This will immediately boost coverage stats to reflect reality.

### 2. Missing Coverage (Logic Gaps)

#### A. Self-Update Mechanism (`src/lib.rs`)
- **Status:** **0% Coverage**
- **Files:** `src/lib.rs` (Lines 333-400, 605-671)
- **Description:** The logic for detecting if the target is the current executable and spawning a temp updater is completely untouched.
- **Action:**
    - Refactor `is_self_update_target` and `try_self_update` to be testable (possibly by allowing the "current exe" path to be mocked or overridden).
    - Add a test case using a dummy executable structure to simulate the self-update flow without risking the actual test runner.

#### B. CLI & UI Logic (`src/cli/mod.rs`)
- **Status:** High, but specific edge cases missing.
- **Gaps:**
    - `--finish-update` internal command (Line 165).
    - Invalid summary format error handling path (Line 222).
    - `print_parse_error` when `UnknownArgs` is empty (Line 259).

#### C. Deployment Logic (`src/lib.rs`)
- **Gaps:**
    - `manifest_bin_names`: Fallback for `[[bin]]` without `name` (Lines 220-225).
    - `find_built_executables`: Error handling for unreadable member manifests (Lines 269-277).
    - `run_with_options`:
        - `fs::create_dir_all` failure (Line 523).
        - "Detected Tauri project" print statement (Line 529).
        - Copy failure reporting (Lines 566-600).
        - Warning printing in non-text mode (Lines 705-707).

## Improvement Plan
1.  **Phase 1: Refactor Integration Tests.** Convert subprocess tests to library calls.
2.  **Phase 2: Target Self-Update.** Implement safe tests for the self-update logic.
3.  **Phase 3: Edge Cases.** Cover remaining error paths and UI conditions.
